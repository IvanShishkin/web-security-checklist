# Чек-лист безопасности для веб-проекта

### Настройка сервера

1. Подключение к серверу по ssh протоколу, должно быть организовано через ssh ключи, а не по паролю
2. Вход должен осуществляться не по одному(общему) ключу, а должны быть добавлены ключи каждого отдельного разработчика
3. Проводить плановые аудиты активных ssh ключей, и корректности настройки ssh 
4. Запретить пользователю root доступ по ssh
    
    ```sql
    vim /etc/ssh/sshd_config
    PermitRootLogin no
    sudo service sshd reload
    ```
    
5. Операционная системы, службы и утилиты должны своевременно получаться обновления. С обновлениями мы получаем фиксы связанные с безопасностью
6. Проверить корректность установки SSL сертификата
    - Проверить в онлайне [https://www.isplicense.ru/ssl-tools/checker/](https://www.isplicense.ru/ssl-tools/checker/)
    - Проверить в терминале через sslscan
7. Настроить заголовков CSP(Content Security Policy) 
    - Информация по настройке [https://habr.com/ru/companies/southbridge/articles/471746/](https://habr.com/ru/companies/southbridge/articles/471746/)
8. Настроить заголовки X-Frame-Option, X-XSS-Protection в ответе веб-сервера
9. Сервер должен иметь минимальное кол-во открытых портов. Обычно, оставляют открытыми из вне 80, 443 и 22 порт
    - Подробнее про возможности эксплуатации открытых портов [https://habr.com/ru/articles/446772/https://habr.com/ru/articles/446772/](https://habr.com/ru/articles/446772/)
    - Простой пример как закрыть порт через iptables
        
        ```sql
        sudo iptables -A INPUT -p tcp --dport <порт> -j DROP
        sudo iptables-save
        ```
        
10. Перенаправляться запросы по протоколу HTTP на HTTPS
11. Настройка мониторинга ssh подключений к серверу
    - Информация настройки мониторинга через zabbix [https://serveradmin.ru/monitoring-ssh-loginov-v-zabbix/](https://serveradmin.ru/monitoring-ssh-loginov-v-zabbix/)
12. Необходимо разграничивать права доступа к файлам и директориям
    - Владелец файлов проекта user:user
    - Директории должны иметь права 644, а директории 755
    - В директории и файлы, которые проект можем создавать и изменять должны иметь владельца www-data:user
13. Никогда не запускаете проект на внутреннем веб-сервере PHP. На продакшенее PHP должен работать как модуль apache  или в режиме fastcgi

### Базы данных

1. Убрать возможность уделанного подключения к вашим базам данных
2. После установки службы баз базы данных не забудьте установить пароль пользователю root и удалить временных пользователей
3. Не работать с базами данных проекта из под пользователя root
4. Создайте для каждой отдельной базе своего отдельного пользователя. Пользователь базы данных должен иметь ограниченные привилегии на выполнения запросов и администрирование
    - Подробнее про создание пользователей и настройку прав доступа в mysql [https://losst.pro/sozdanie-polzovatelya-mysql#2_Права_пользователя_MySQL](https://losst.pro/sozdanie-polzovatelya-mysql#2_%D0%9F%D1%80%D0%B0%D0%B2%D0%B0_%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F_MySQL)
5. Включить ведение журнала запросов
6. Удаление истории взаимодействия с оболочкой
    - `cat /dev/null > ~/.mysql_history`

### Кодовая база

Список для PHP проекта

1. Безопасная структура проекта
    1. Вынести публичные скрипты в отдельную директорию и сделать ее DOCUMENT_ROOT проекта
    2. Директории и файлы `.git, .env, logs, .gitignore, composer.json, vendor`необходимо вынести вне DOCUMENT_ROOT проекта или закрыть доступ к ней по HTTP через конфигурацию веб-сервера. Более правильный вариант - возвращать 404 статус, чтобы не раскрывать существование данной директории
        
        ```sql
        #nginx
        location ~ /\.git {
          return 404;
        }
        ```
        
    3. В публичной части сайта не должны содержаться технические или тестовые файлы(phpinfo.php, test.php и т.д.)
2. Правила написания кода
    1. Не хранить доступы(пароли, api токены, и другие учетные данные) прямо в коде проекта. Для хранения такой информации лучше использовать .env файл
    2. Всегда валидируйте пользовательские данные.
        - В PHP функции ****htmlspecialchars, strip_tags, trim, htmlentities, filter_var****
    3. Никогда не подставляйте пользовательские данные с функции eval, ****shell_exec****
    4. При работе выполнении запросов правильно использовать подготовленные запросы
        - В mysqli [https://www.php.net/manual/ru/mysqli.quickstart.prepared-statements.php](https://www.php.net/manual/ru/mysqli.quickstart.prepared-statements.php)
        - В PDO [https://www.php.net/manual/ru/pdo.prepared-statements.php](https://www.php.net/manual/ru/pdo.prepared-statements.php)
    5. При загрузке файлов проверяйте расширения файлов и его тип
        
        ```php
        $extension = pathinfo($fileName, PATHINFO_EXTENSION);
        ```
        
        ```php
        $file = new SplFileInfo($fileName);
        $extension = $file->getExtension();
        ```
        
    6. Загруженные файлы файлы должны быть переименованы при попадании в хранилище
3. Аудит зависимостей проектам
    1. При выборе пакета убедитесь, что он от реального вендора, а не форк злоумышленника
    2. Не рекомендуется устанавливать пакеты мало популярных библиотек. Если вы на это все же решились, потратьте время на ревью кодовой базы этого проекта 
    3. Для проверки уязвимостей в фронтенд проекте используем npm audit
    4. Для проверки composer пакетов [https://github.com/FriendsOfPHP/security-advisories#checking-for-vulnerabilities](https://github.com/FriendsOfPHP/security-advisories#checking-for-vulnerabilities) или [https://github.com/Roave/SecurityAdvisories](https://github.com/Roave/SecurityAdvisories) 
    5. Аудит уязвимостей должен быть автоматизирован, обычно реализуют в виде отдельного шага CI/CD
4. Отказаться от стандартный адресов административной панели. Адреса по типу /bitrix, /admin, /wp-admin и т.д.
    1. Перенести адрес админ панели на более сложный(уникальный url)
    2. Разрешить доступ только определенным IP адресам
    3. Добавить дополнительную basic авторизацию
